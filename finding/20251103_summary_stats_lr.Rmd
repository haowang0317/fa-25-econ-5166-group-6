---
title: "Statistical Analysis of Employee Satisfaction Data and Logit Regression"
author: "林渭倫 R13227114"
output: html_document
date: "`r format(Sys.time(), '%Y-%m-%d')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Background

-   **Author**: `林渭倫`
-   **Created At**: `2025-10-30`
-   **Research Motivation and Context (why are we interested in the findings?)：**
    -   近年來對於勞工權益的意識抬頭，職場霸凌等等的新聞也層出不窮。也因為距離進入職場不算太久，所以我們想要知道可能會有哪些因素導致勞工對於工作的滿意度上升，並且作為日後挑選工作的考量之一。
-   **Main Findings and Takeaways：**
    -   對於「工作場所」、「工作時間」、「薪水」、「工作負荷量」、「性別工作平等」、「主管」、「同事之間的相處情形」、「員工申訴管道」、「人事考核升遷制度」、「員工教育訓練」越滿意，則對於整體而言的工作滿意度就越高。年齡越高、認為將來失業的可能性越低、在工作中未遭遇到困難，則對於整體而言的工作滿意度就越高。且在教育程度上，直到教育程度為博士生，教育程度對於工作滿意度的影響才會和教育程度為國中生及以下有差別。
-   **Future Direction：**
    -   進一步探討這些因素可能會如何去影響整體工作滿意度，並且做出更細緻的解釋。

```{r load-packages}
# Load packages here
library(tidyverse)
library(kableExtra)
library(glmnet)
library(sandwich)
library(lmtest)
# library(MASS)
# library(Hmisc)
# conflicted::conflict_prefer_all("dplyr")
```

```{r load-data}
# Load input data here and please finish all the data manipulation here.
# Finish this block by printing the first ten observations of the data.
# Note:
# - You may only read data from /data/processed.
# - Files in /data/processed should already be cleaned and prepared for analysis.
# - Beyond simple filtering of observations or generating a small number of variables,
#   further data manipulation is not allowed. If more extensive changes are needed,
#   update the source data instead.
# setwd(dirname(rstudioapi::getActiveDocumentContext()$path))  # set the working directory to this Rmd file
dat <- read.csv("../data/processed/processed_data112_01.csv")

# dat %>% str

dat <- dat %>% 
  mutate_at(-c(14, 15, 16, 20, 22, 29, 30), as.factor) %>%   # convert mislabeled factor into actual factor
  mutate(
    education = fct_relevel(education, "junior_high_or_lower"),  # make the level "junior_hight_or_lower" to be base
    county = fct_relevel(county, "keelung")  # make the level "keelung" to be base
  )

head(dat, 10) %>%
  kable("html", caption="First 10 observations of the employee satisfication data") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  scroll_box(width = "100%")
```

```{r}
# Before conducting the analysis, report summary statistics for all variables 
# that will be used in this notebook:
#   - For numeric variables: mean, min, 25th percentile, median, 75th percentile, 
#     max, standard deviation, and number of observations.
#   - For categorical variables: number of observations and the counts/percentages 
#     of the ten most frequent categories.
# Conclude this block with the complete summary statistics.
```

### The actual analysis starts below

Make the graphs, summary statistics, regression model below. Make sure you have followed the guidelines as specified in [專案資料夾結構、檔案命名與文件規範](https://docs.google.com/document/d/1sl6gEFMdmiGsiNjLe17UmZ30xKxq15U0Mb2B-Jvusxg/edit?tab=t.33iie8ybx7s4).

```{r colname, include=F, echo=F}
col.name <- c("scale", "satisfy_environment", "satisfy_work_hours", "satisfy_wage", "satisfy_work_load", "satisfy_gender_equality", "satisfy_supervisor_care", "satisfy_colleague", "satisfy_complaint_channel", "satisfy_assess_and_promote", "satisfy_education_training", "satisfy_accessible", "satisfy_overall", "overtime_hours", "has_assignment_off_work", "can_remotely_work", "think_job_has_good_career_dev_prospect", "think_lose_job_in_6_months", "opinion_on_working_hours", "participate_training_in_past_year", "work_leisure_balance", "troubles_at_work", "work_type", "gender", "age", "education", "work_income", "county", "serviced_months_current", "serviced_months_total")
```

## Summary Statistics

### Numeric Variables

```{r summary-stat-numeric}
dat %>% 
  summarise(across(c(14, 29, 30), .fns=list(
    mean = ~ round(mean(.), 3),
    min = min,
    Q25 = ~ quantile(., .25),
    median = median,
    Q75 = ~ quantile(., .75),
    max = max,
    sd = ~ round(sd(.), 3),
    "#obs" = ~ length(.)
  ))) %>% 
  pivot_longer(everything(), names_pattern = "^(.*)_([^_]+)$", names_to = c("variable", ".value")) %>%
  mutate(variable = str_replace_all(variable, "_", " ")) %>% 
  kable("html", caption="Summary Statistics of Numeric Variables") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

大部分的加班時間(`overtime_hours`)都小於5，而有少數界外值。經過討論，我們決定保留加班時間的界外值。 儘管最大值為100，已遠超勞基法規定的每月加班上限54小時，但考慮到雇主或許會要求員工打卡下班後繼續無償加班，我們仍決定保留該違法的資料，以反映加班時間極長對於工作滿意度的影響。 而兩種工作年資月份的統計很合理，從開始工作以來的工作年資月份會大於等於在目前服務單位的工作年資月份，且前者也會有較大的標準差。 此外，由兩種工作年資月份的最大值可得知也有填答者從開始工作就一直待在同一間公司，持續48年。

The histograms of the numeric variables:

```{r plot-numeric, message=F}
dat %>% 
  select(c(14, 29, 30)) %>% 
  pivot_longer(everything()) %>% 
  ggplot(aes(value)) +
  geom_histogram() +
  facet_wrap(
    ~ str_to_title(str_replace_all(name, "_", " ")),
    scales="free"
  ) +
  labs(
    title = "Histograms of Numeric Variables"
  ) +
  theme_light()
```

可觀察到：

-   加班時間有兩筆大於Q75的值。

-   在目前工作單位的工作年資月份相較於從開始工作以來的月份來說，分配較為高狹，即較集中於較小的月份。

### Categorical Variables

```{r summary-stat-catogorical}
cate_summary <- dat %>% 
  select(-c(14, 29, 30)) %>% 
  mutate(across(where(is.numeric), .fns = ~ as.factor(.x))) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "level") %>% 
  count(variable, level, name="count") %>% 
  group_by(variable) %>% 
  mutate(
    percentage = round(count / sum(count), 4),
    percentage = paste0(percentage * 100, "%")
  ) %>% 
  arrange(variable, desc(count)) %>% 
  filter(row_number() <= 10)

level_count <- cate_summary %>% count(variable)
row_group <- level_count$n
names(row_group) <- level_count$variable %>% paste0(": #obs=4095")

cate_summary[, -1] %>% 
  kable("html", caption="Summary Statistics of Categorical Variables") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  # collapse_rows(1, row_group_label_position = "first") %>% 
  pack_rows(index=row_group) %>% 
  footnote("Only list the top 10 levels.") %>% 
  scroll_box(height = "500pt")
```

在此表中，有某些值得一提的數據：

在填答者的特質中，約有半數的填答者為大學學歷、男女性別比為 $`r (100 * 1965/2130) %>% round(2)`:100$ ，約有 $8\%$ 的填答者的工作型態為兼職或打工。 有超過8成的填答者認為工時適中，不需增加或減少。 在滿意度的總共12題中，絕大多數的人填寫的都是很滿意(`1`)、滿意(`2`)或普通(`3`)。 約為8成的填答者月薪落在 $26,400 \sim 59,999$ 之間。

```{r barplot-satisfy-overall}
sat.overall.obs <- select(dat, satisfy_overall) %>%
  table %>% 
  as.data.frame()

dat %>% 
  select(satisfy_overall) %>% 
  ggplot(aes(satisfy_overall)) +
  geom_bar() +
  geom_text(data = sat.overall.obs, aes(x=satisfy_overall, y=Freq + 100, label=Freq)) +
  labs(
    title = "Barplot of Employee's Overall Satisfaction", 
    x = "Overall Satisfaction", y = "Count"
  ) +
  scale_x_discrete(labels=c(
    "1" = "Very satisfied (1)",
    "2" = "Satisfied (2)",
    "3" = "Neutral (3)",
    "4" = "Dissatisfied (4)",
    "5" = "Very dissatisfied (5)"
  )) +
  theme_light()
```

此外，可以發現填答者在總體工作滿意度上，回答幾乎都集中在從非常滿意到普通，即僅有少數人不滿意其工作。 考慮到不滿意的資料在不同變數之下，會有樣本數不足的問題，因此後續的分析將著重在區分「總體工作滿意度是否為3分以上」，即區分「滿意以上」以及「普通以下」。

## Logistic Regression

由於我們希望了解的「勞工工作滿意度」為 categorical variable，無法使用 linear regression 進行資料分析，故我們使用 logistic regression 來探討影響勞工工作滿意度的因素。 而因為變數眾多（30個），可能導致模型中出現變數之間共線性（collinearity）的問題，因此先使用 L1 penalty 來進行變數選擇。 我們先透過 10-fold cross-validation 來選擇 lasso 的懲罰係數，使得使用該係數時，cross-validation error 最低。

```{r cv-lambda, cache=T}
dat.1 <- dat %>% 
  mutate(
    y = as.numeric(satisfy_overall) <= 2,
    y = as.numeric(y)
  ) %>% 
  select(-satisfy_overall) %>% 
  relocate(y)
x <- model.matrix(y ~ ., dat.1)[, -1]
y <- dat.1$y

set.seed(2025)
cv.lasso <- cv.glmnet(x, y, alpha=1, family="binomial")
lambda.min <- cv.lasso$lambda.min

# plot(cv.lasso)
# title(main="Cross-Validatoin Error Across log(Lambda)", cex.main=.5)

data.frame(
  lambda = cv.lasso$lambda,
  mean.cv.error = cv.lasso$cvm,
  sd.cv.error = cv.lasso$cvsd,
  cvup = cv.lasso$cvup,
  cvlo = cv.lasso$cvlo
) %>% 
  ggplot(aes(x=-log(lambda), y=mean.cv.error)) +
  geom_point(color="red") +
  geom_errorbar(aes(ymin=cvlo, ymax=cvup)) +
  geom_vline(xintercept = -log(cv.lasso$lambda.min), linetype=2) +
  annotate("text", x=-log(cv.lasso$lambda.min) + 1.2, y=1, label="-log(lambda)=-5.72115\nlambda=0.00328") +
  labs(title = "Cross-Validatoin Error Across log(Lambda)", y = "Mean Cross-Validation Error") +
  theme_light()
```

此圖為懲罰係數 $\lambda$ 和 10-fold cross-validation error 之間的關係。可觀察到當 $\lambda=`r round(lambda.min, 5)`$ 時，會有最小的 mean cross-validation error。 因此，接下來我們使用該 $\lambda$ 值進行 lasso logistic regression，挑選在此懲罰係數之下，其斜率項係數仍未收縮到 0 的變數。

```{r cv-lambda-coef}
lasso.best.coef <- coef(cv.lasso, lambda.min)[, 1] %>% 
  as.data.frame()

colnames(lasso.best.coef) <- "lasso.estimate"
row_group.all <- c(1, rep(4, 12), 1, 1, 1, 4, 4, 2, 1, 3, 1, 1, 1, 11, 5, 6, 19, 1, 1)
names(row_group.all) <- c(  # specify omitted groups
  "Intercept", "scale (omitted group: 0-29)", 
  "satisfy_environment (omitted group: level 1)", "satisfy_work_hours (omitted group: level 1)", 
  "satisfy_wage (omitted group: level 1)", "satisfy_work_load (omitted group: level 1)",
  "satisfy_gender_equality (omitted group: level 1)", "satisfy_supervisor_care (omitted group: level 1)",
  "satisfy_colleague (omitted group: level 1)", "satisfy_complaint_channel (omitted group: level 1)",
  "satisfy_assess_and_promote (omitted group: level 1)", "satisfy_education_training (omitted group: level 1)",
  "satisfy_accessible (omitted group: level 1)", 
  "overtime_hours", "has_assignment_off_work", "can_remotely_work",
  "think_job_has_good_career_dev_prospect (omitted group: level 1)", 
  "think_lose_job_in_6_months (omitted group: level 1)", "opinion_on_working_hours (omitted group: keep)",
  "participate_training_in_past_year",
  "work_leisure_balance (omitted group: balanced)", "troubles_at_work", "work_type (omitted group: all_time)",
  "gender (omitted group: female)", "age (omitted group: 15-19)", 
  "education (omitted group: junior_high_or_lower)",
  "work_income (omitted group: 0-26399)", "county (omitted group: keelung)",
  "serviced_months_current", "serviced_months_total"
)


lasso.best.coef %>% 
  rownames_to_column(var="variable") %>% 
  mutate(
    lasso.estimate = ifelse(lasso.estimate == 0, ".", sprintf("%.3f", lasso.estimate))
  ) %>% 
  rename("Lasso Estimate" = lasso.estimate) %>% 
  kable("html", caption="Estimates of Lasso Logistic Regression") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  # collapse_rows(1, row_group_label_position = "first") %>% 
  pack_rows(index=row_group.all) %>%
  footnote("The period '.' indicates that the estimate equals to zero.") %>%
  scroll_box(height = "500pt")
```

此表為 lasso logistic regression 的係數，表中 `Lasso Estimate` 欄位中為 `.` 者即表示其係數已收縮到 0。 在變數的選擇上，僅保留係數未收縮到 0 的 numeric variable，以及有任一 level 的係數未收縮到 0 的 categorical variable。 根據此結果，仍應保留的變數為: `scale`, `satisfy_environment`, `satisfy_work_hours`, `satisfy_wage`, `satisfy_work_load`, `satisfy_gender_equality`, `satisfy_supervisor_care`, `satisfy_colleague`, `satisfy_complaint_channel`, `satisfy_assess_and_promote`, `satisfy_education_training`, `satisfy_accessible`, `can_remotely_work`, `think_job_has_good_career_dev_prospect`, `think_lose_job_in_6_months`, `opinion_on_working_hours`, `work_leisure_balance`, `troubles_at_work`, `work_type`, `age`, `education`, `work_income`, `county`。 而其餘變數則而因變數間高度相關而導致其係數收縮到0，不需保留。

接下來，我們使用上述的變數再進行一次 logistic regression，觀察這些變數中，哪些變數會對應變數有影響。

```{r logit-final, warning=F}
dat.2 <- dat.1 %>% 
  select(c(
    y, scale, satisfy_environment, satisfy_work_hours, satisfy_wage, satisfy_work_load, satisfy_gender_equality, satisfy_supervisor_care, satisfy_colleague, satisfy_complaint_channel, satisfy_assess_and_promote, satisfy_education_training, satisfy_accessible, can_remotely_work, think_job_has_good_career_dev_prospect, think_lose_job_in_6_months, opinion_on_working_hours, work_leisure_balance, troubles_at_work, work_type, age, education, work_income, county
  ))

# fit logistic regression
logit <- glm(y ~ ., data = dat.2, family = "binomial")
logit.robust <- coeftest(logit, vcov = vcovCL, type="HC1", df= 11 , cluster = ~ age)
broom::tidy(logit.robust, conf.int=T) %>%
  mutate(
    p.value = case_when(
      p.value < 0.01 ~ paste0(sprintf("%.3f", p.value), "***"),
      p.value < 0.05 ~ paste0(sprintf("%.3f", p.value), "**"),
      p.value < 0.1 ~ paste0(sprintf("%.3f", p.value), "*"),
      TRUE ~ sprintf("%.3f", p.value)
    )
  ) %>% 
  rename(
    Variable = term,
    Estimate = estimate,
    Std.error = std.error,
    Statistic = statistic,
    Confidence.Low = conf.low,
    Confidence.High = conf.high
  ) %>% 
  kable("html", caption="Variable Selected Logistic Regression Result") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>% 
  pack_rows(index=row_group.all[-c(14, 15, 20, 24, 29, 30)]) %>%
  scroll_box(width = "100%", height="500pt") 
```

經過變數選擇後，我們使用 cluster-robust standard error 控制年齡。 此結果顯示達到顯著的變數為：

-   截距
-   工作場所滿意度的普通和不滿意（相較於非常滿意）：係數皆為負
-   工作時間滿意度的普通、不滿意和非常不滿意（相較於非常滿意）：係數皆為負
-   薪水滿意度的普通、不滿意和非常不滿意（相較於非常滿意）：係數皆為負
-   工作負荷量滿意度的普通、不滿意和非常不滿意（相較於非常滿意）：係數皆為負
-   性別工作平等滿意度的普通和非常不滿意（相較於非常滿意）：係數皆為負
-   主管滿意度的普通和不滿意（相較於非常滿意）：係數皆為負
-   同事相處滿意度的普通和非常不滿意（相較於非常滿意）：係數皆為負
-   員工申訴管道滿意度的普通（相較於非常滿意）：係數為負
-   人事考核升遷制度滿意度的不滿意和非常不滿意（相較於非常滿意）：係數皆為負
-   員工教育訓練滿意度的普通和不滿意（相較於非常滿意）：係數皆為負
-   覺得未來6個月內可能會失業的不可能和非常不可能（相較於非常滿意）：係數皆為正
-   在工作中遭遇到困擾：係數為負
-   年齡（相較於15\~19歲）：係數皆為正
-   教育程度的博士生（相較於國中生以下）：係數為正
-   工作縣市的嘉義縣、新竹縣、花蓮縣、高雄市、南投縣、台北市（相較於基隆市）：係數皆為正

我們可以得到以下推論：

-   對於「工作場所」、「工作時間」、「薪水」、「工作負荷量」、「性別工作平等」、「主管」、「同事之間的相處情形」、「員工申訴管道」、「人事考核升遷制度」、「員工教育訓練」越滿意，則對於整體而言的工作滿意度就越高。

-   認為將來6個月內失業的可能性越低，則對於該工作越滿意。

-   在工作中遭遇到困難會導致對於該工作不滿意。

-   年齡越高，則對於整體而言的工作滿意度就越高。

-   在教育程度上，直到教育程度為博士生，教育程度對於工作滿意度的影響才會和教育程度為國中生及以下有差別；其餘教育程度者，教育程度對於工作滿意度的影響並沒有顯著的差別。

-   其餘變數則對於勞工的整體工作滿意度而言，其影響未達到顯著水準。

我們認為大多數的滿意度量表可以反映到整體的工作滿意度上，這件事情很合理。整體的工作滿意度即由這些因素所構成，故各分項的分數自然會和整體的工作滿意度有關。\
然而在這些滿意度量表中，唯一未達顯著的是對於無障礙環境的滿意度。這或許反映了大多數人不見得都會使用到無障礙設施，因此對於這些設施滿意與否就和整體的工作滿意度無關。

我們認為「在工作中遭遇到困難」和整體工作滿意度之間的關係看似很直觀，遭遇到困難似乎自然會對工作不滿意。但或許也會有某些喜歡面對挑戰的人，反而無法做簡單乏味的工作，這時在工作上遇到困難對他來說反而是證明自己或是挑戰困難事務的機會。這或許可以解釋為何其顯著水準未小於 0.01。

而年齡的影響，或許是因為年紀較小的人，還因為經濟壓力等等因素而待在自己不滿意的工作環境中，尚未換到其他公司，或是轉換工作跑道；而年紀較大者，或許已經習慣了他的職場和工作內容，因此滿意其工作。
