---
title: "Statistical Analysis of Employee Satisfaction Data and Logit Regression"
author: "林渭倫 R13227114"
output: 
  html_document:
    code_folding: hide
date: "`r format(Sys.time(), '%Y-%m-%d')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Background

-   **Author**: `林渭倫`
-   **Created At**: `2025-11-10`
-   **Research Motivation and Context (why are we interested in the findings?)：**
    -   近年來對於勞工權益的意識抬頭，職場霸凌等等的新聞也層出不窮。也因為距離進入職場不算太久，所以我們想要知道可能會有哪些因素導致勞工對於工作的滿意度上升，並且作為日後挑選工作的考量之一。
-   **Main Findings and Takeaways：**
    -   對於「工作場所」、「工作時間」、「薪水」、「工作負荷量」、「性別工作平等」、「主管」、「同事相處」、「員工申訴管道」、「人事考核升遷制度」、「員工教育訓練」越滿意，則對工作越滿意。年齡越高、認為將來失業的可能性越低、在工作中未遭遇到困難，亦會對工作越滿意。且影響力最大的因素為工作時間和同事相處情形。除此之外，我們還對「工時」和「實際的薪水」兩個變數為何在模型中沒有影響提出了可能的解釋。
-   **Future Direction：**
    -   大致上為最終的版本。

```{r load-packages}
# Load packages here
library(tidyverse)
library(kableExtra)
library(effectsize)
library(glmnet)
library(sandwich)
library(lmtest)
library(ggpubr)
library(brglm2)
```

```{r load-data}
# Load input data here and please finish all the data manipulation here.
# Finish this block by printing the first ten observations of the data.
# Note:
# - You may only read data from /data/processed.
# - Files in /data/processed should already be cleaned and prepared for analysis.
# - Beyond simple filtering of observations or generating a small number of variables,
#   further data manipulation is not allowed. If more extensive changes are needed,
#   update the source data instead.
# setwd(dirname(rstudioapi::getActiveDocumentContext()$path))  # set the working directory to this Rmd file
dat <- read.csv("../data/processed/processed_data112_01.csv")

satisfy <- c("非常滿意" = "1", "滿意" = '2', "普通" = '3', "不滿意" = '4', "非常不滿意" = '5')
col.name <- c(
  "公司規模" = "scale", "環境滿意度" = "satisfy_environment", "工作時數滿意度" = "satisfy_work_hours",
  "薪資滿意度" = "satisfy_wage", "工作負荷量滿意度" = "satisfy_work_load",
  "性別工作平等滿意度" = "satisfy_gender_equality", "主管滿意度" = "satisfy_supervisor_care", 
  "同事相處滿意度" = "satisfy_colleague", "申訴管道滿意度" = "satisfy_complaint_channel", 
  "人事考核升遷滿意度" = "satisfy_assess_and_promote", "教育訓練滿意度" = "satisfy_education_training",
  "無障礙環境滿意度" = "satisfy_accessible", "整體滿意度" = "satisfy_overall", "加班時數" = "overtime_hours",
  "下班後是否還被以訊息交辦工作" = "has_assignment_off_work", "是否可以遠距工作" = "can_remotely_work",
  "工作有好的職涯前景" = "think_job_has_good_career_dev_prospect", 
  "未來6個月有可能會失業嗎" = "think_lose_job_in_6_months", "對於目前工作時數的看法" = "opinion_on_working_hours",
  "最近一年內有無參加教育訓練" = "participate_training_in_past_year",
  "目前工作與休閒的平衡狀況" = "work_leisure_balance", "在工作上有無遭遇到困擾" = "troubles_at_work", 
  "工作型態" = "work_type", "性別" = "gender", "年齡" = "age", "教育程度" = "education", "收入水準" = "work_income",
  "工作所在縣市" = "county", "在目前單位的服務年資" = "serviced_months_current", 
  "開始工作至今的服務年資" = "serviced_months_total"
)
level_regex <- paste0("^(", paste(col.name, collapse = "|"), ")")

dat <- dat %>% 
  mutate_at(-c(14, 15, 16, 20, 22, 29, 30), as.factor) %>%   # convert mislabeled factor into actual factor
  mutate(
    education = fct_relevel(education, "junior_high_or_lower"),  # make the level "junior_hight_or_lower" to be base
    county = fct_relevel(county, "keelung"),  # make the level "keelung" to be base
    work_income = fct_recode(
      work_income, "0-26K"="0-26399", "26K-30K"="26400-29999", "30K-40K"="30000-39999",
      "40K-60K"="40000-59999", "60K-80K"="60000-79999", "80K-100K"="80000-99999", "100K+"="100000+"
    ),
    work_income = fct_relevel(
      work_income, "0-26K", "26K-30K", "30K-40K", "40K-60K", "60K-80K", "80K-100K", "100K+"
    ),
    across(starts_with("satisfy_"), ~ fct_recode(.x, !!!satisfy)),
    opinion_on_working_hours = fct_recode(
      opinion_on_working_hours, 
      "減少" = "reduce", "維持" = "keep", "增加" = "raise"
    ),
    work_leisure_balance = fct_recode(
      work_leisure_balance, 
      "工作太多" = "too_much_work", "工作有點多" = "more_work", 
      "工作和休閒平衡" = "balanced", "休閒有點多" = "more_leisure"
    ),
    work_type = fct_recode(
      work_type, 
      "全時工作" = "all_time", "兼職" = "part_time"
    ),
    education = fct_recode(
      education, 
      "國中及以下" = "junior_high_or_lower", "高中" = "high_school", "大學" = "university",
      "碩士" = "master", "博士" = "phd", "專科" = "vocational"
    ),
    gender = fct_recode(
      gender, 
      "男" = "male", "女" = "female"
    ),
    county = fct_recode(
      county,
      "台北" = "taipei", "花蓮" = "hualien", "台中" = "taichung", "高雄" = "kaohsiung", "宜蘭" = "yilan", 
      "台南" = "tainan", "新北市" = "new_taipei", "台東" = "taitung", "基隆" = "keelung", "桃園" = "taoyuan",
      "苗栗" = "miaoli", "彰化" = "changhua", "新竹縣" = "hsinchu_county", "南投" = "nantou", "新竹市" = "hsinchu_city",
      "屏東" = "pingtung", "澎湖" = "penghu", "嘉義縣" = "chiayi_county", "雲林" = "yunlin", "嘉義市" = "chiayi_city"
    ),
    think_job_has_good_career_dev_prospect = fct_recode(
      think_job_has_good_career_dev_prospect,
      "非常同意" = "1", "同意" = '2', "普通" = '3', "不同意" = '4', "非常不同意" = '5'
    ),
    think_lose_job_in_6_months = fct_recode(
      think_lose_job_in_6_months,
      "非常有可能" = "1", "可能" = '2', "普通" = '3', "不可能" = '4', "非常不可能" = '5'
    ),
  )

head(dat, 10) %>%
  rename(any_of(col.name)) %>% 
  kable("html", caption="First 10 observations of the employee satisfication data") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  scroll_box(width = "100%")
```

```{r notebook-description}
# Before conducting the analysis, report summary statistics for all variables 
# that will be used in this notebook:
#   - For numeric variables: mean, min, 25th percentile, median, 75th percentile, 
#     max, standard deviation, and number of observations.
#   - For categorical variables: number of observations and the counts/percentages 
#     of the ten most frequent categories.
# Conclude this block with the complete summary statistics.
```

### The actual analysis starts below

Make the graphs, summary statistics, regression model below. Make sure you have followed the guidelines as specified in [專案資料夾結構、檔案命名與文件規範](https://docs.google.com/document/d/1sl6gEFMdmiGsiNjLe17UmZ30xKxq15U0Mb2B-Jvusxg/edit?tab=t.33iie8ybx7s4).

## Summary Statistics

### Numeric Variables

```{r summary-stat-numeric, warning=F}
numeric.summary <- dat %>% 
  summarise(
    across(
      c(14, 29, 30), 
      .fns=list(
        mean = ~ round(mean(.), 3),
        min = min,
        Q25 = ~ quantile(., .25),
        median = median,
        Q75 = ~ quantile(., .75),
        max = max,
        sd = ~ round(sd(.), 3),
        "#obs" = ~ length(.)
      )
    )
  ) %>% 
  pivot_longer(
    everything(), 
    names_pattern = "^(.*)_([^_]+)$",
    names_to = c("variable", ".value")
  )

numeric.summary %>% 
  # mutate(variable = str_replace_all(variable, "_", " ")) %>% 
  mutate(
    variable = as.factor(variable),
    variable = fct_recode(variable, !!!col.name)
  ) %>% 
  kable("html", caption="Summary Statistics of Numeric Variables") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

大部分的加班時間(`overtime_hours`)都小於5，而有少數界外值。經過討論，我們決定保留加班時間的界外值。 儘管最大值為100，已遠超勞基法規定的每月加班上限54小時，但考慮到雇主或許會要求員工打卡下班後繼續無償加班，我們仍決定保留該違法的資料，以反映加班時間極長對於工作滿意度的影響。 而兩種工作年資月份的統計很合理，從開始工作以來的工作年資月份會大於等於在目前服務單位的工作年資月份，且前者也會有較大的標準差。 此外，由兩種工作年資月份的最大值可得知也有填答者從開始工作就一直待在同一間公司，持續48年。

The histograms of the numeric variables:

```{r plot-numeric, message=F, warning=F}
theme_set(theme_grey(base_family = "Microsoft YaHei"))  # set the font of Chinese

dat %>% 
  select(c(14, 29, 30)) %>% 
  pivot_longer(everything()) %>% 
  mutate(
    name = fct_recode(as.factor(name), !!!col.name)
  ) %>% 
  ggplot(aes(value)) +
  geom_histogram() +
  facet_wrap(
    ~ str_to_title(str_replace_all(name, "_", " ")),
    scales="free"
  ) +
  labs(
    title = "數值變數的直方圖",
    y = "數量",
    x = ""
  ) +
  theme_light()
```

可觀察到：

-   加班時間有兩筆大於Q75的值。

-   在目前工作單位的工作年資月份相較於從開始工作以來的月份來說，分配較為高狹，即較集中於較小的月份。

### Categorical Variables

```{r summary-stat-catogorical, warning=F}
cate_summary <- dat %>% 
  select(-c(14, 29, 30)) %>% 
  mutate(across(where(is.numeric), .fns = ~ as.factor(.x))) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "level") %>% 
  count(variable, level, name="count") %>% 
  group_by(variable) %>% 
  mutate(
    percentage = round(count / sum(count), 4),
    percentage = paste0(percentage * 100, "%")
  ) %>% 
  arrange(variable, desc(count)) %>% 
  filter(row_number() <= 10)

level_count <- cate_summary %>% count(variable)
row_group <- level_count$n
names(row_group) <- level_count$variable %>%
  as.factor %>% 
  fct_recode(., !!!col.name) %>% 
  paste0(": #obs=4095")

cate_summary[, -1] %>% 
  kable("html", caption="Summary Statistics of Categorical Variables") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  # collapse_rows(1, row_group_label_position = "first") %>% 
  pack_rows(index=row_group) %>% 
  footnote("Only list the top 10 levels.") %>% 
  scroll_box(height = "500pt")
```

在此表中，有某些值得一提的數據：

在填答者的特質中，約有半數的填答者為大學學歷、男女性別比為 $`r (100 * 1965/2130) %>% round(2)`:100$ ，約有 $8\%$ 的填答者的工作型態為兼職或打工。 有超過8成的填答者認為工時適中，不需增加或減少。 在滿意度的總共12題中，絕大多數的人填寫的都是很滿意、滿意或普通。 約為8成的填答者月薪落在 $26,400 \sim 59,999$ 之間。

```{r barplot-satisfy-overall}
sat.overall.obs <- select(dat, satisfy_overall) %>%
  table %>% 
  as.data.frame()

dat %>% 
  select(satisfy_overall) %>% 
  ggplot(aes(satisfy_overall)) +
  geom_bar() +
  geom_text(data = sat.overall.obs, aes(x=satisfy_overall, y=Freq + 100, label=Freq)) +
  labs(
    title = "員工整體滿意度的柱狀圖", 
    x = "整體滿意度", y = "數量"
  ) +
  theme_light()
```

此外，可以發現填答者在總體工作滿意度上，回答幾乎都集中在從非常滿意到普通，即僅有少數人不滿意其工作。 考慮到不滿意的資料在不同變數之下，會有樣本數不足的問題，因此後續的分析將著重在區分「總體工作滿意度是否為2分以下」，即區分「滿意以上」以及「普通以下」，並簡稱為「對工作是否滿意」。

### Correlations Between Variables

```{r pair-correlation-matrix, fig.dim = c(10, 10), message=F}
cor.mat <- dat %>% 
  select(-c(14, 29, 30)) %>%  # extract categorical data
  mutate(
    scale = recode(
      scale,
      "0-29" = 1, "30-49" = 2, "50-199" = 3, "200-499" = 4, "500+" = 5
    ),
    opinion_on_working_hours = recode(
      opinion_on_working_hours,
      "減少" = 1, "維持" = 2, "增加" = 3
    ),
    work_leisure_balance = recode(
      work_leisure_balance,
      "工作太多" = 1, "工作有點多" = 2, "工作和休閒平衡" = 3, "休閒有點多" = 4
    ),
    work_type = recode(
      work_type,
      "全時工作" = 1, "兼職" = 2
    ),
    gender = recode(
      gender,
      "女" = 0, "男" = 1
    ),
    age = recode(
      age,
      "15-19" = 1, "20-24" = 2, "25-29" = 3, "30-34" = 4, "35-39" = 5, "40-44" = 6, "45-49" = 7, "50-54" = 8,
      "55-59" = 9, "60-64" = 10, "65-69" = 11, "70+" = 12
    ),
    education = recode(
      education,
      "國中及以下" = 1, "高中" = 2, "專科" = 3, "大學" = 4, "碩士" = 5, "博士" = 6
    ),
    work_income = recode(
      work_income,
      "0-26K" = 1, "26K-30K" = 2, "30K-40K" = 3, "40K-60K" = 4, "60K-80K" = 5, "80K-100K" = 6, "100K+" = 7
    ),
    county = as.integer(county) %>% as.factor(),
    across(is.factor, as.integer)
  ) %>%
  rename(any_of(col.name[-c(14, 29, 30)])) %>%
  # select(-c(age, county)) %>% 
  # str()
  cor(., method="spearman") %>% 
  round(4) %>% 
  as.data.frame()

var_order <- colnames(cor.mat)

cor.mat %>% 
  rownames_to_column(var = "Variable.1") %>% 
  pivot_longer(-Variable.1, names_to = "Variable.2", values_to = "correlation") %>%
  mutate(
    Variable.1 = factor(Variable.1, levels = var_order),
    Variable.2 = factor(Variable.2, levels = rev(var_order))
  ) %>% 
  ggplot(aes(x=Variable.1, y=Variable.2, fill=correlation)) +
  geom_tile(color="gray") +
  scale_fill_gradient2(
    low = "blue", high = "red", mid = "white", 
    midpoint = 0, limit = c(-1,1), 
    space = "Lab", name = "Spearman\nCorrelation"
  ) +
  geom_text(aes(Variable.2, Variable.1, label=correlation), color="black", size=2) +
  ggtitle("Spearman Correlation Matrix Heatmap") +
  theme(
    axis.text.x = element_text(
      angle = 90 , hjust = 1, vjust = .3, size = 6
    ),
    axis.text.y = element_text(size = 6),
    axis.title.x = element_text(hjust = .2)
  ) +
  labs(x = "變數1", y="變數2") +
  coord_fixed()

cor.mat %>% 
  kable("html", caption="Spearman Correlation Matrix of Categorical Variables") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>% 
  scroll_box(height = "500pt", width = "100%")
```

此表為類別變數之間的相關係數 heat map 以及相對應的矩陣。可以發現除了12個滿意度問題之間相關較高之外，其餘變項之間的相關大多數並不高。 而這一個整體而言的滿意度以及 11 個子向度的問題之間相關較高（相關係數介於 0.525 到 0.795），說明問卷調查本身具有高度的內部一致性，不過可能也表示填答者在子向度問題的回答上，有一定程度受到整體滿意度的影響。

此外，由於年資和年齡之間或許存在著某些關係，因此我們藉由 $\eta^2$ statistic 來檢驗 `年齡` 分別和 `在目前單位的服務年資` 與 `開始工作至今的服務年資` 這兩個變數之間的關係。

```{r cor-age-serviced-months}
cat(
  "Pearson correlation between serviced_months_current and serviced_months_total\n",
  cor(dat$serviced_months_current, dat$serviced_months_total) %>% round(4), "\n\n\n"
)

cat("Variations of serviced_months_current explained by age:\n")
aov(serviced_months_current ~ age, data = dat) %>% eta_squared()

cat("\n\n\nVariations of serviced_months_total explained by age:\n")
aov(serviced_months_total ~ age, data = dat) %>% eta_squared()
```

由於 `開始工作至今的服務年資` 的變異可被 `年齡` 解釋的比例約為 76%，此為相當高的比例。 因此在後續的分析中，或許可以用年齡來取代年資的變數。

## Logistic Regression

由於我們希望了解的「對工作是否滿意」為二元變項，無法使用 linear regression 進行資料分析，故我們使用 logistic regression 來探討影響勞工工作滿意度的因素。

### Lasso Regression for Variable Selection

由於變數眾多（30個），可能因模型中出現變數之間共線性（collinearity）的問題，導致估計上的問題。因此我們先使用 L1 penalty 來進行變數選擇。

在執行上，我們先透過 10-fold cross-validation 來選擇 lasso 的懲罰係數，使得使用該係數時，cross-validation error 最低。

```{r cv-lambda, cache=T}
dat.1 <- dat %>% 
  mutate(
    y = as.numeric(satisfy_overall) <= 2,
    y = as.numeric(y)
  ) %>% 
  select(-satisfy_overall) %>% 
  relocate(y)
x <- model.matrix(y ~ ., dat.1)[, -1]
y <- dat.1$y

# print(colnames(x))

set.seed(2025)
cv.lasso <- cv.glmnet(x, y, alpha=1, family="binomial")
lambda.min <- cv.lasso$lambda.min

# plot(cv.lasso)
# title(main="Cross-Validatoin Error Across log(Lambda)", cex.main=.5)

data.frame(
  lambda = cv.lasso$lambda,
  mean.cv.error = cv.lasso$cvm,
  sd.cv.error = cv.lasso$cvsd,
  cvup = cv.lasso$cvup,
  cvlo = cv.lasso$cvlo
) %>% 
  ggplot(aes(x=-log(lambda), y=mean.cv.error)) +
  geom_point(color="red") +
  geom_errorbar(aes(ymin=cvlo, ymax=cvup)) +
  geom_vline(xintercept = -log(cv.lasso$lambda.min), linetype=2) +
  annotate("text", x=-log(cv.lasso$lambda.min) + 1.2, y=1, label="-log(lambda)=-5.72115") +
  annotate("text", x=-log(cv.lasso$lambda.min) + .95, y=.95, label="lambda=0.00328") +
  labs(title = "Cross-Validatoin Error Across log(Lambda)", y = "Mean Cross-Validation Error") +
  theme_light()
```

此圖為懲罰係數 $\lambda$ 和 10-fold cross-validation error 之間的關係。可觀察到當 $\lambda=`r round(lambda.min, 5)`$ 時，會有最小的 mean cross-validation error。 因此，接下來我們使用該 $\lambda$ 值進行 lasso logistic regression，挑選在此懲罰係數之下，其斜率項係數仍未收縮到 0 的變數。

```{r cv-lambda-coef}
lasso.best.coef <- coef(cv.lasso, lambda.min)[, 1] %>% 
  as.data.frame()

colnames(lasso.best.coef) <- "lasso.estimate"
row_group.all <- c(1, rep(4, 12), 1, 1, 1, 4, 4, 2, 1, 3, 1, 1, 1, 11, 5, 6, 19, 1, 1)
names(row_group.all) <- c(  # specify omitted groups
  "Intercept", "公司規模 (omitted group: 0-29)", 
  "環境滿意度 (omitted group: 非常滿意)", "工作時數滿意度 (omitted group: 非常滿意)", 
  "薪資滿意度 (omitted group: 非常滿意)", "工作負荷量滿意度 (omitted group: 非常滿意)",
  "性別工作平等滿意度 (omitted group: 非常滿意)", "主管滿意度 (omitted group: 非常滿意)",
  "同事相處滿意度 (omitted group: 非常滿意)", "申訴管道滿意度 (omitted group: 非常滿意)",
  "人事考核升遷滿意度 (omitted group: 非常滿意)", "教育訓練滿意度 (omitted group: 非常滿意)",
  "無障礙環境滿意度  (omitted group: 非常滿意)", 
  "加班時數", "下班後是否還被以訊息交辦工作", "是否可以遠距工作",
  "工作有好的職涯前景 (omitted group: 非常同意)", 
  "未來6個月有可能會失業嗎 (omitted group: 非常有可能)", "對於目前工作時數的看法  (omitted group: 維持不變)",
  "最近一年內有無參加教育訓練",
  "目前工作與休閒的平衡狀況 (omitted group: 平衡)", "在工作上有無遭遇到困擾", "工作型態 (omitted group: 全時工作)",
  "性別 (omitted group: female)", "年齡 (omitted group: 15-19)", 
  "教育程度 (omitted group: 國中或以下)",
  "收入水準 (omitted group: 0-26K)", "工作所在縣市 (omitted group: 基隆)",
  "在目前單位的服務年資", "開始工作至今的服務年資"
)

lasso.best.coef %>% 
  rownames_to_column(var="Variable") %>%
  mutate(
    lasso.estimate = ifelse(lasso.estimate == 0, ".", sprintf("%.3f", lasso.estimate)),
    var.eng = str_extract(Variable, level_regex),
    var.chn = fct_recode(as.factor(var.eng), !!!col.name),
    level = str_remove(Variable, level_regex),
    Variable = case_when(
    is.na(var.chn) ~ "Intercept",
    level == "" ~ var.chn,
    .default = paste(var.chn, level, sep=": ")
    )
  ) %>% 
  select(-c(var.eng, var.chn, level)) %>%
  rename("Lasso Estimate" = lasso.estimate) %>% 
  kable("html", caption="Estimates of Lasso Logistic Regression") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  # collapse_rows(1, row_group_label_position = "first") %>% 
  pack_rows(index=row_group.all) %>%
  footnote("The period '.' in 'Lasso Estimate' column indicates that the estimate equals to zero.") %>%
  scroll_box(height = "500pt")
```

此表為 lasso logistic regression 的係數，表中 `Lasso Estimate` 欄位中為 `.` 者即表示其係數已收縮到 0。 在變數的選擇上，僅保留係數未收縮到 0 的數值變數，以及有任一 level 的係數未收縮到 0 的類別變數。 根據此結果，仍應保留的變數為: `公司規模`, `環境滿意度`, `工作時數滿意度`, `薪資滿意度`, `工作負荷量滿意度`, `性別工作平等滿意度`, `主管滿意度 `, `同事相處滿意度`, `申訴管道滿意度`, `人事考核升遷滿意度`, `教育訓練滿意度`, `無障礙環境滿意度`, `是否可以遠距工作`, `工作有好的職涯前景`, `未來6個月有可能會失業嗎`, `對於目前工作時數的看法`, `目前工作與休閒的平衡狀況`, `在工作上有無遭遇到困擾`, `工作型態`, `年齡`, `教育程度`, `收入水準`, `工作所在縣市`。 而其餘變數則而因變數間高度相關而導致其係數收縮到0，不需保留。

### Logistic Regression with Fewer Variables

完成粗略的變數篩選後，我們使用上述的變數再進行一次 logistic regression，觀察這些變數中，哪些變數會對「對工作是否滿意」有影響。

```{r logit-final, warning=F}
dat.2 <- dat.1 %>% 
  select(c(
    y, scale, satisfy_environment, satisfy_work_hours, satisfy_wage, satisfy_work_load, satisfy_gender_equality, satisfy_supervisor_care, satisfy_colleague, satisfy_complaint_channel, satisfy_assess_and_promote, satisfy_education_training, satisfy_accessible, can_remotely_work, think_job_has_good_career_dev_prospect, think_lose_job_in_6_months, opinion_on_working_hours, work_leisure_balance, troubles_at_work, work_type, age, education, work_income, county
  ))

# fit logistic regression
logit <- glm(y ~ ., data = dat.2, family = "binomial")
logit.robust <- coeftest(logit, vcov = vcovHC(logit, type="HC1"))

logit_coef.robust <- broom::tidy(logit.robust, conf.int=T)
logit_coef.robust %>%
  mutate(
    p.value = case_when(
      p.value < 0.0001 ~ "<1e-4 ***",
      p.value < 0.01 ~ paste(sprintf("%.3f", p.value), "***"),
      p.value < 0.05 ~ paste(sprintf("%.3f", p.value), "**"),
      p.value < 0.1 ~ paste(sprintf("%.3f", p.value), "*"),
      TRUE ~ sprintf("%.3f", p.value)
    )
  ) %>%  
  rename(
    Variable = term,
    Estimate = estimate,
    Std.error = std.error,
    Statistic = statistic,
    Confidence.Low = conf.low,
    Confidence.High = conf.high
  ) %>% 
  mutate(
    var.eng = str_extract(Variable, level_regex),
    var.chn = fct_recode(as.factor(var.eng), !!!col.name),
    level = str_remove(Variable, level_regex),
    Variable = case_when(
    is.na(var.chn) ~ "Intercept",
    level == "" ~ var.chn,
    .default = paste(var.chn, level, sep=": ")
    )
  ) %>% 
  select(-c(var.eng, var.chn, level)) %>%
  kable("html", caption="Variable Selected Logistic Regression Result") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>% 
  pack_rows(index=row_group.all[-c(14, 15, 20, 24, 29, 30)]) %>%
  scroll_box(width = "100%", height="500pt") 
```

此結果顯示某些類別變數中有部分的 levels 達到顯著，即相對於參照點來說，該 level 和參照點之間具有差異。 但我們仍無法知道該類別變數**整體而言**是否對於模型有解釋能力，因此需要以其他方法來檢驗整個類別變數的效果，而非單一 level 顯著與否。

### Likelihood Ratio Test

接下來我們取出所有 p-value \< 0.05 的變數，或是類別變數中有其中一個 level 的 p-value \< 0.05 的變數。 以這些變數對「對工作是否滿意」重新進行一次 logistic regression，並且對這個新的模型進行 likelihood ratio test，比較每次移除其中一個變數之後，新的模型是否表現的比原有的模型好，藉此檢驗每個類別變數整體而言是否有助於解釋資料。

```{r LRT}
LRT <- car::Anova(
  glm(
    y ~ satisfy_environment + satisfy_work_hours + satisfy_wage + satisfy_work_load + satisfy_gender_equality 
    + satisfy_supervisor_care + satisfy_colleague + satisfy_complaint_channel + satisfy_assess_and_promote
    + satisfy_education_training + satisfy_accessible + think_lose_job_in_6_months + work_leisure_balance
    + troubles_at_work + age + county,
    data = dat.2, family = "binomial"
  ),
  type=2, test.statistic="Wald"
)

LRT %>% 
  rownames_to_column("Variable") %>% 
  rename(p.value = "Pr(>Chisq)") %>% 
  mutate(
    p.value = case_when(
      p.value < 0.0001 ~ "<1e-4 ***",
      p.value < 0.01 ~ paste(sprintf("%.3f", p.value), "***"),
      p.value < 0.05 ~ paste(sprintf("%.3f", p.value), "**"),
      p.value < 0.1 ~ paste(sprintf("%.3f", p.value), "*"),
      TRUE ~ cell_spec(sprintf("%.3f", p.value), "html", color="green")
    ),
    Chisq = round(Chisq, 3),
    Variable = as.factor(Variable),
    Variable = fct_recode(Variable, !!!col.name)
  ) %>%
  kable("html", escape=F, caption="Likelihood Ratio Test of Removing Each Variables") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

可以發現在這些變數之中，`目前工作與休閒的平衡狀況` 和 `工作所在縣市` 兩個變數未達到顯著。 說明這兩個變數儘管在某些 level 上和分別的參照點有差異，但整個變數在解釋資料上並無顯著影響。 因此，我們決定拿掉這兩個變數，進行最後的迴歸分析。

### Final Logistic Regression

我們藉著 logistic regression 來觀察各個變數在方向上是如何影響填答者對工作是否滿意。

```{r final-logit}
logit_final <- glm(
    y ~ satisfy_environment + satisfy_work_hours + satisfy_wage + satisfy_work_load + satisfy_gender_equality 
    + satisfy_supervisor_care + satisfy_colleague + satisfy_complaint_channel + satisfy_assess_and_promote
    + satisfy_education_training + satisfy_accessible + think_lose_job_in_6_months + troubles_at_work + age,
    data = dat.2, family = "binomial"
  )
logit_final.robust <- coeftest(logit_final, vcov = vcovHC(logit_final, type="HC1"))

logit_final_coef.robust <- broom::tidy(logit_final.robust, conf.int=T) %>% 
  rename(
    Variable = term,
    Estimate = estimate,
    Std.Error = std.error,
    Statistic = statistic,
    Confidence.Low = conf.low,
    Confidence.High = conf.high
  )

logit_final_coef.robust %>%
  mutate(
    p.value = case_when(
      p.value < 0.0001 ~ cell_spec("<1e-4***", "html", color="red"),
      p.value < 0.01 ~ cell_spec(paste0(sprintf("%.3f", p.value), "***"), "html", color="red"),
      p.value < 0.05 ~ cell_spec(paste0(sprintf("%.3f", p.value), "**"), "html", color="red"),
      p.value < 0.1 ~ paste0(sprintf("%.3f", p.value), "*"),
      TRUE ~ sprintf("%.3f", p.value)
    )
  ) %>%
  mutate(
    Odds.Ratio = round(exp(Estimate), 3),
    Estimate = round(Estimate, 3),
    Std.Error = round(Std.Error, 3),
    Statistic = round(Statistic, 3),
    Confidence.Low = round(Confidence.Low, 3),
    Confidence.High = round(Confidence.High, 3)
  ) %>% 
  relocate(Odds.Ratio, .after = Estimate) %>%
  mutate(
    var.eng = str_extract(Variable, level_regex),
    var.chn = fct_recode(as.factor(var.eng), !!!col.name),
    level = str_remove(Variable, level_regex),
    Variable = case_when(
    is.na(var.chn) ~ "Intercept",
    level == "" ~ var.chn,
    .default = paste(var.chn, level, sep=": ")
    )
  ) %>% 
  select(-c(var.eng, var.chn, level)) %>%
  kable("html", caption="Variable Selected Logistic Regression Result", escape=F) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
  pack_rows(index=row_group.all[-c(2, 14, 15, 16, 17, 19, 20, 21, 23, 24, 26:30)]) %>%
  scroll_box(width = "110%", height="500pt")
```

為了方便檢視，我們拿掉多餘的資訊，關注斜率估計值的 p-value \< 0.05 的變數，留下斜率的估計值及其信賴區間，並且計算 odds ratio、其信賴區間和其倒數，方便比較變數之間的重要程度。

```{r final-logit-sig-coef}
row_group.final <- row_group.all[-c(2, 13:17, 19:21, 23, 24, 26:30)]
row_group.final[1:length(row_group.final)] <- c(1, 2, 3, 3, 3, 1, 3, 2, 1, 2, 2, 1, 1, 3)

logit_final_coef.robust %>%
  filter(p.value < .05) %>% 
  select(c(Variable, Estimate, Confidence.Low, Confidence.High)) %>%
  mutate(
    Estimate.CI = paste0("[", round(Confidence.Low, 3), ", ", round(Confidence.High, 3), "]"),
    Estimate = round(Estimate, 3),
    Odds.Ratio = exp(Estimate),
    OR.inv = round(1/Odds.Ratio, 3),
    Odds.Ratio = round(Odds.Ratio, 3),
    OR.CI.L = round(exp(Confidence.Low), 3),
    OR.CI.H = round(exp(Confidence.High), 3),
    Odds.Ratio.CI = paste0("[", OR.CI.L, ", ", OR.CI.H, "]"),
    # specify cell color
    Odds.Ratio = cell_spec(Odds.Ratio, "html", color = ifelse(Odds.Ratio > 1e3, "red", "black")),
    OR.inv = cell_spec(OR.inv, "html", color = ifelse(OR.inv > 1e3, "red", "black"))
  ) %>%
  select(-c(OR.CI.L, OR.CI.H, Confidence.Low, Confidence.High)) %>% 
  rename("1/Odds.Ratio" = OR.inv) %>% 
  mutate(
    var.eng = str_extract(Variable, level_regex),
    var.chn = fct_recode(as.factor(var.eng), !!!col.name),
    level = str_remove(Variable, level_regex),
    Variable = case_when(
    is.na(var.chn) ~ "Intercept",
    level == "" ~ var.chn,
    .default = paste(var.chn, level, sep=": ")
    )
  ) %>% 
  select(-c(var.eng, var.chn, level)) %>%
  kable("html", caption="Variable Selected Logistic Regression Result", escape=F) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
  pack_rows(index=row_group.final)
```


```{r final-logit-coef-plot}
logit_final_coef.robust %>%
  filter(p.value < .05) %>% 
  mutate(
    # level name: English to Chinese
    var.eng = str_extract(Variable, level_regex),
    var.chn = fct_recode(as.factor(var.eng), !!!col.name),
    level = str_remove(Variable, level_regex),
    Variable = case_when(
      is.na(var.chn) ~ "Intercept",
      level == "" ~ var.chn,
      .default = paste(var.chn, level, sep=": ")
    ),
    Variable = as.factor(Variable),
    # value
    Odds.Ratio = exp(Estimate),
    OR.inv = 1/Odds.Ratio,
    pos = Odds.Ratio >= 1,
    LB = exp(Confidence.Low) ^ (2 * pos - 1),
    UB = exp(Confidence.High) ^ (2 * pos - 1)
  ) %>%
  select(c(Variable, Odds.Ratio, OR.inv, LB, UB)) %>%
  rename("1/(Odds Ratio)" = OR.inv) %>% 
  pivot_longer(-c(Variable, LB, UB), names_to = "OR") %>% 
  filter(value >= 1) %>% 
  filter(Variable != "Intercept") %>% 
  mutate(value = ifelse(value > 1e3, Inf, value)) %>% 
  ggplot(aes(x=value, y=Variable, fill=OR)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(xmin=LB, xmax=UB)) +
  xlim(0, 30) +
  labs(
    title = "各變數對於「勞工對工作是否滿意」勝算比的影響倍數",
    x="", y="", fill=""
  ) +
  theme(axis.text.y = element_text(hjust=0)) +
  theme_light()
```

此圖為變數的 odds ratio 或其倒數，方便在同一尺度下比較不同變數的重要性。值越大則表示該變數的影響程度越高。
可以發現最重要的變數為 `年齡`、`工作時間滿意度`、`同事相處滿意度`。

#### 結果

經過變數選擇後，我們使用 cluster-robust standard error 進行控制。 此結果顯示斜率估計值的 p-value \< 0.05 的變數為以下所列：

| 變數 | Levels | 方向說明 |
|----|----|----|
| 截距 | \- | \+ |
| 工作場所滿意度 | 「普通」和「不滿意」（相較於「非常滿意」） | -：對此子向度越滿意則對工作越滿意 |
| 工作時間滿意度 | 「普通」、不滿意」和非常不滿意」（相較於「非常滿意」） | -：對此子向度越滿意則對工作越滿意 |
| 薪水滿意度 | 「普通」、「不滿意」和「非常不滿意」（相較於「非常滿意」） | -：對此子向度越滿意則對工作越滿意 |
| 工作負荷量滿意度 | 「普通」、「不滿意」和「非常不滿意」（相較於「非常滿意」） | -：對此子向度越滿意則對工作越滿意 |
| 性別工作平等滿意度 | 「普通」（相較於「非常滿意」） | -：對此子向度越滿意則對工作越滿意 |
| 主管滿意度 | 「普通」、「不滿意」和「非常不滿意」（相較於「非常滿意」） | -：對此子向度越滿意則對工作越滿意 |
| 同事相處滿意度 | 「普通」和「非常不滿意」（相較於「非常滿意」） | -：對此子向度越滿意則對工作越滿意 |
| 員工申訴管道滿意度 | 「普通」（相較於「非常滿意」） | -：對此子向度越滿意則對工作越滿意 |
| 人事考核升遷制度滿意度 | 「不滿意」和「非常不滿意」（相較於「非常滿意」） | -：對此子向度越滿意則對工作越滿意 |
| 員工教育訓練滿意度 | 「普通」和「不滿意」（相較於「非常滿意」） | -：對此子向度越滿意則對工作越滿意 |
| 「覺得未來6個月內可能會失業」 | 「不可能」（相較於「非常可能」） | +：越覺得自己不會被開除則對工作越滿意 |
| 在工作中遭遇到困擾 | 是 | -：在工作中遭遇困難會對工作不滿意 |
| 年齡 | 「40 \~ 44歲」、「45 \~ 49歲」以及「70歲以上」（相較於15\~19歲） | +：年齡越大則對工作越滿意 |

: Logistic Regression Result

而其餘變數則對於勞工「對工作是否滿意」而言，其影響未達到顯著水準。


#### 可能的解釋

我們認為大多數的滿意度量表可以反映到整體的工作滿意度上，這件事情很合理。整體的工作滿意度即由這些因素所構成，故各分項的分數自然會和整體的工作滿意度有關。 然而在這些滿意度量表中，唯一未達顯著的是對於無障礙環境的滿意度。這或許反映了大多數人不見得都會使用到無障礙設施，因此對於這些設施滿意與否就和整體的工作滿意度無關。

我們認為「在工作中遭遇到困難」和「對工作是否滿意」之間的關係看似很直觀，遭遇到困難似乎自然會對工作不滿意。但或許也會有某些喜歡面對挑戰的人，反而無法做簡單乏味的工作，這時在工作上遇到困難對他來說反而是證明自己或是挑戰困難事務的機會。這或許可以解釋為何其顯著水準未小於 0.01。

而年齡的影響，或許是因為年紀較小的人，還因為經濟壓力等等因素而不得不待在自己不滿意的工作環境中，尚未換到其他公司，或是轉換工作跑道，仍在忍受著自己不滿意的工作。\
而年紀較大者，或許是因為已經習慣了他的職場和工作內容，因此滿意其工作；也可能是在找到滿意的工作後就定下來，不再大幅度的改變自己的工作。

此外，由 odds ratio 及其倒數可觀察到，對於「對工作是否滿意」影響最大（標註紅色者，數值最大）的變數為「工作時間」、「同事之間的相處情形」、「年齡」。不過其中的年齡是因為在70歲以上的填答者僅有3名，且這三名皆回應「對工作滿意」，因此才會有如此高的 odds ratio。\
我們認為前兩個變數之所以會有最大的影響，是因為工作時間以及同事是每天的工作中最常接觸到的（工作負荷量的影響則在子向度的滿意度中佔第三大，只是沒有前兩個這麼大）。在工作中最常互動到的通常會是同事，且工時則和下班後的閒暇時間息息相關。因此會有很大的影響。


#### 其餘變數探討

不過除了這些 p-value \< 0.05 的變數之外，資料中也有部分變數是我們原先認為應該會有影響，但卻未能在最終的結果中看到其影響，包括加班時數以及收入。

##### 加班時數

我們先畫出加班時數以及對工作是否滿意之間的關係。

```{r hist-overtime-satisfy-overall}
plot_overtime.base <- dat.1 %>% 
  select(c(overtime_hours, y)) %>% 
  mutate(
    y = as.factor(y),
    y = recode(y, "1" = "滿意", "0" = "不滿意")
  ) %>% 
  ggplot(aes(overtime_hours, fill=y)) +
  labs(
    x = "加班時間 (小時)",
    fill = "整體滿意度"
  ) +
  theme_light() +
  theme(
    legend.title = element_text(margin = margin(r = 45)),
    legend.text = element_text(margin = margin(r = 20))
  )

plot_overtime.1 <- plot_overtime.base +
  geom_histogram() +
  labs(
    title = "加班時間的頻率分布\n以總體滿意度分層",
    y ="數量"
  )
plot_overtime.2 <- plot_overtime.base +
  geom_histogram(position="fill") +
  geom_vline(xintercept = 5, color="lightgray") +
  annotate("text", x=9, y=.5, label="Q3=5", color="lightgray") +
  xlim(0, 51) +
  labs(
    title = "總體滿意度在\n加班時間之下的比例分布",
    subtitle = "聚焦在加班時間為 0~50 小時",
    y = "比例 (%)"
  )

ggarrange(plot_overtime.1, plot_overtime.2, legend="bottom", common.legend = T)
```

還記得先前提到，加班時數的 $Q3=5$，也就是說絕大多數的資料中，加班時數都不多。
並且可以觀察到在 Q3 以內的資料中，對工作是否滿意的比例差異並不大。差異要在有更多的加班時數後才會更加明顯。
這些比例之間的微小差異或許不足以解釋勞工對工作是否滿意，因此才會在 lasso regression 時就被移除。


##### 收入

在進行分析之前，我們認為收入應該會是影響工作滿意度的重要因素，但分析的結果中，這個變數的影響並未達到顯著。
我們觀察在最終的模型中，與 `工作收入` 之間相關最高的變數為 `年齡`，因此我們把不同年齡層的收入薪資級距比例視覺化。

```{r income-age}
dat.1 %>% 
  # select(c(work_income, age)) %>% 
  filter(age != "70+") %>% 
  mutate(work_income = fct_relevel(work_income, rev)) %>% 
  ggplot(aes(age, fill=work_income)) +
  geom_bar(position="fill") +
  labs(
    title = "工作收入在不同年齡層的比例分布", 
    x = "年齡",
    y = "比例 (%)",
    fill = "工作收入 (TWD)"
  ) +
  theme_light()
```

可以看到年齡和收入之間存在著一定的關係，當年齡越高，低薪的佔比也隨之有下降的趨勢，整體而言薪資會隨著年齡上升而上升。
因此儘管收入在 lasso regression 中並沒有被篩選掉，但是控制年齡後，收入的解釋力就跟著下降。


```{r income-satisfy-analysis}
plot_wage.1 <- dat %>% 
  mutate(satisfy_wage = as.numeric(satisfy_wage)) %>%
  group_by(work_income) %>% 
  summarise(Mean.satisfy_wage = mean(satisfy_wage), .groups="drop") %>% 
  ggplot(aes(x = work_income, y = Mean.satisfy_wage)) +
  geom_point(size = 2) +
  scale_y_reverse(limits = c(5, 1)) +
  labs(
    title = "薪資滿意度在\n不同收入水準下的平均分數",
    x = "工作收入 (TWD)",
    y = "薪資滿意度的平均分數"
  ) +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_wage.2 <- dat %>% 
  mutate(satisfy_wage = as.numeric(satisfy_wage)) %>% 
  group_by(work_income, satisfy_work_load) %>%
  summarise(Mean.satisfy_wage = mean(satisfy_wage), .groups="drop") %>% 
  ggplot(aes(x = work_income, y = Mean.satisfy_wage, group = satisfy_work_load, color = satisfy_work_load)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_y_reverse(limits = c(5, 1)) +
  labs(
    title = "工作負荷量滿意度和收入水準\n對於薪資滿意度的交互作用",
    # subtitle = "Non-parallel lines suggest interaction",
    x = "工作收入 (TWD)",
    y = "薪資滿意度的平均分數",
    color = "工作負荷量滿意度"
  ) +
  theme_light() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    legend.title = element_text(margin = margin(r = 70)),
    legend.text = element_text(margin = margin(r = 20))
  )

ggarrange(plot_wage.1, plot_wage.2, legend="bottom", common.legend = T)
```

觀察左圖，可以發現實際的薪資與薪資滿意度的整體趨勢並非實際薪資越高，對於其薪水的滿意程度就越高。因此兩者中間應有調節變項。
再觀察右圖，可發現控制對於工作量的滿意度後，才能發現實際薪資和薪資滿意度之間較為明顯的線性關係。
對於工作量滿意度高的人，實際的薪資影響薪資滿意度的程度並不大；不過對於工作量滿意度低的人，則需要高薪來維持薪資滿意度。
因此企業若無法提供高薪（特別是在 30K-40K 級距），改善員工的工作量感受將是提升薪資滿意度最有效的策略。