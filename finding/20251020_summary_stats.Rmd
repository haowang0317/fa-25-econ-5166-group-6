---
title: "Statistical Analysis of Employee Satisfaction Data"
author: "林渭倫 R13227114"
output: html_document
date: "`r format(Sys.time(), '%Y-%m-%d')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Background

-   **Author**: `林渭倫`
-   **Created At**: `2025-10-20`
-   **Research Motivation and Context (why are we interested in the findings?)：**
    -   We want to know how the participants response. Knowing them helps us specify our model.
-   **Main Findings and Takeaways：**
    -   We have 28 variables and 4095 participants. We have accomplished the summary statistics of 3 numeric variables and 25 categorical variables. The distributions of the variables seems fine.
-   **Future Direction：**
    -   Ask DE to rename the variables and their values. After that, the discussion of the results will be accelerated.

```{r load-packages}
# Load packages here
library(tidyverse)
library(kableExtra)
# library(MASS)

# conflicted::conflict_prefer_all("dplyr")
```

```{r load-data}
# Load input data here and please finish all the data manipulation here.
# Finish this block by printing the first ten observations of the data.
# Note:
# - You may only read data from /data/processed.
# - Files in /data/processed should already be cleaned and prepared for analysis.
# - Beyond simple filtering of observations or generating a small number of variables,
#   further data manipulation is not allowed. If more extensive changes are needed,
#   update the source data instead.
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))  # set the working directory to this Rmd file
dat <- read.csv("../data/processed/processed_data112.csv")

dat <- dat %>% 
  mutate_at(-c(14, 29, 30), as.factor)  # convert mislabeled factor into actual factor
head(dat, 10) %>%
  kable("html", caption="First 10 observations of the employee satisfication data") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

However, DE haven't rename the variables and the value. The job will be done soon (hopefully).

```{r}
# Before conducting the analysis, report summary statistics for all variables 
# that will be used in this notebook:
#   - For numeric variables: mean, min, 25th percentile, median, 75th percentile, 
#     max, standard deviation, and number of observations.
#   - For categorical variables: number of observations and the counts/percentages 
#     of the ten most frequent categories.
# Conclude this block with the complete summary statistics.
```

### The actual analysis starts below

Make the graphs, summary statistics, regression model below. Make sure you have followed the guidelines as specified in [專案資料夾結構、檔案命名與文件規範](https://docs.google.com/document/d/1sl6gEFMdmiGsiNjLe17UmZ30xKxq15U0Mb2B-Jvusxg/edit?tab=t.33iie8ybx7s4).

## Summary Statistics

### Numeric Variables

```{r summary-stat-numeric}
dat %>% 
  rename_with(~ gsub("_", ".", .x, fixed=T)) %>%   # replace the "_" in the column name. should be fixed after naming of columns
  summarise(across(-where(is.factor), .fns=list(
    mean = mean,
    min = min,
    Q25 = ~ quantile(., .25),
    median = median,
    Q75 = ~ quantile(., .75),
    max = max,
    sd = sd,
    "#obs" = ~ length(.)
  ))) %>% 
  pivot_longer(everything(), names_sep = "_", names_to = c("variable", ".value")) %>% 
  kable("html", caption="Summary Statistics of Numeric Variables") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>% 
  footnote("The naming of variables and the values should be done by DE.")
```

It seems that most of the extra hours are smaller than 5. After discussion, we decided to keep the observations that have extremely high extra hours. Having 100 extra hours means working 5 hours overtime in average. Although the Labor Standards Act (LSA) stipulates that monthly overtime hours must not exceed 100 hours, we decided to include this data in the analysis, considering that some companies might require employees to work unpaid overtime by having them clock out and then continue working.

The wide range in years of service indicates that this survey includes employees from both senior and junior levels, which may allow us to better observe the effect of seniority on employee satisfaction.

<!-- The histograms of the numeric variables: -->

```{r plot-numeric, include=F, echo=F}
dat %>% 
  select(-is.factor) %>% 
  pivot_longer(everything()) %>% 
  ggplot(aes(value)) +
  geom_histogram() +
  facet_wrap(~ name, scales="free") +
  labs(title = "Histograms of Numeric Variables") +
  theme_light()
```

### Categorical Variables

```{r summary-stat-catogorical}
cate_summary <- dat %>% 
  # rename_with(~ gsub("_", ".", .x, fixed=T)) %>%   # replace the "_" in the column name. should be fixed after naming of columns
  summarise(across(where(is.factor), .fns=list(
    # n = ~ length(.),
    level = ~ list(table(.))
  ))) %>% 
  pivot_longer(everything(), names_sep = "_", names_to = c("variable", ".value")) %>%   # arrange to #obs and levels
  unnest_wider(level) %>%  # unnest the count of levels 
  mutate(across(num_range("", 0:20), as.numeric)) %>%   # change the data type of count
  pivot_longer(  # sort columns of levels to a single column `count` and its naming `level`
    num_range("", 0:20),
    names_to = "level", values_to = "count"
  ) %>% 
  drop_na() %>%  # remove excess levels
  group_by(variable) %>% 
  mutate(
    percentage = (100 * count / sum(count)) %>%  # compute percentage across different variables
      round(2) %>% 
      paste0("%")
  ) %>% 
  arrange(variable, desc(count)) %>%  # sorting by variable
  filter(row_number() <= 10)  # only focus on the ten most frequent categories

level_count <- cate_summary %>% count(variable)
row_group <- level_count$n
names(row_group) <- level_count$variable %>% paste0(": #obs=4095")

cate_summary[, -1] %>% 
  kable("html", caption="Summary Statistics of Categorical Variables") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  # collapse_rows(1, row_group_label_position = "first") %>% 
  pack_rows(index=row_group) %>% 
  footnote("The naming of variables and the values should be done by DE.")
```

To note that the naming of variables and the values should be done by DE.\
The distributions of items about satisfaction shows that the employees are satisfy with their job (the coding `1` denotes "very satisfied"). Further discussion will be done after the naming is done.

<!-- We first defined a function that helps drawing pie chart of categorical variables. -->

```{r plot-categorical, include=F, echo=F}
piechart <- function(dat, var.range=1:9) {
  dat %>%
    filter(variable %in% unique(.$variable)[var.range]) %>%
    # arrange(variable, count) %>% 
    ggplot(aes(x="", y=count, fill=level)) +
    geom_bar(stat="identity", width=1, color="white") +
    coord_polar("y", start=0) +
    theme_void() +
    geom_text(
      # aes(label = paste0(count, " (", percentage, ")")),
      aes(label = level),
      size = 3, position = position_stack(vjust = .5)
    ) +
    facet_wrap(~ variable, scales="free", drop=T) +
    labs(title = "Piecharts of Categorical Variables")
}

n.chart <- 6
for (i in seq(1, 27, n.chart)) {
  print(piechart(cate_summary, i:(i + n.chart - 1)))
}
```

<!-- ## Ordinal logistic regression -->

```{r olr, include=F, echo=F}
olr.emp <- MASS::polr(a12 ~ ., data=dat)

# summary(olr.emp)
```

```{r coef, include=F, echo=F}
coef_olr.emp <- coef(summary(olr.emp)) %>% 
  as.data.frame() %>% 
  rename_with(~ gsub(" ", ".", .x, fixed=T)) %>% 
  rownames_to_column("variables") %>% 
  mutate(
    p.value = pnorm(abs(t.value), lower.tail=F)*2
  ) %>% 
  mutate(across(-1, ~ round(., 3)))

confint_olr.emp <- confint.default(olr.emp) %>% 
  as.data.frame() %>% 
  round(3) %>% 
  rename_with(~ gsub(" %", "% CI", .x)) %>% 
  rownames_to_column("variables")

left_join(coef_olr.emp, confint_olr.emp) %>% 
  mutate(
    p.value = cell_spec(
      p.value, "html", 
      color=ifelse(p.value < .05, "red", "black")
    )
  ) %>% 
  kable("html", escape=F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

```{r likelihood-ratio-test, include=F, echo=F}
car::Anova(olr.emp, type=3)
```
